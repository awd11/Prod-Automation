<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SharePoint Dashboard (Test)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .controls { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    table { border-collapse: collapse; width: 100%; margin-top:12px; }
    th, td { border: 1px solid #ddd; padding:8px; }
    th { background:#f3f3f3; text-align:left; }
    #messages { color: red; margin-top:8px; }
  </style>
</head>
<body>
  <h2>SharePoint Dashboard (Demo)</h2>

  <div class="controls">
    <label>List:
      <select id="listName">
        <option>Firsttime_Prod_Audible_V4</option>
        <option>Image_Buk_2024_V9</option>
        <option>3P Ingestion Workflow</option>
        <option>ACX+QA+2024</option>
        <option>NPT</option>
      </select>
    </label>

    <label>Start: <input id="start" type="date" /></label>
    <label>End: <input id="end" type="date" /></label>

    <button id="fetchBtn">Fetch</button>
    <button id="productivityBtn">Productivity (simple)</button>
  </div>

  <div id="messages"></div>

  <div id="summary"></div>

  <div id="tableContainer"></div>

<script>
const API_BASE = "http://localhost:8080"; // change to your backend URL when deployed

function showMessage(msg, isError=true){
  const el = document.getElementById('messages');
  el.style.color = isError ? 'red' : 'green';
  el.textContent = msg;
}

function isoToShort(dateStr){
  if(!dateStr) return '';
  return dateStr;
}

document.getElementById('fetchBtn').addEventListener('click', async () => {
  const listName = document.getElementById('listName').value;
  const startRaw = document.getElementById('start').value;
  const endRaw = document.getElementById('end').value;
  if(!startRaw || !endRaw){ showMessage("Pick start and end date"); return; }
  // convert yyyy-mm-dd -> mm/dd/yyyy which backend expects
  const toMMDDYYYY = d => {
    const dt = new Date(d);
    const m = String(dt.getMonth()+1).padStart(2,'0');
    const day = String(dt.getDate()).padStart(2,'0');
    return `${m}/${day}/${dt.getFullYear()}`;
  };
  const body = { list_name: listName, start_date: toMMDDYYYY(startRaw), end_date: toMMDDYYYY(endRaw) };
  showMessage("Fetching...", false);
  try{
    const res = await fetch(API_BASE + "/fetch-list", { method: "POST", headers: {'content-type':'application/json'}, body: JSON.stringify(body) });
    if(!res.ok){ const txt = await res.text(); showMessage("Error: " + txt); return; }
    const data = await res.json();
    showMessage("Fetched OK", false);
    renderList(data);
  }catch(err){
    showMessage("Fetch failed: " + err);
  }
});

document.getElementById('productivityBtn').addEventListener('click', async () => {
  const startRaw = document.getElementById('start').value;
  const endRaw = document.getElementById('end').value;
  if(!startRaw || !endRaw){ showMessage("Pick start and end date"); return; }
  const toMMDDYYYY = d => {
    const dt = new Date(d);
    const m = String(dt.getMonth()+1).padStart(2,'0');
    const day = String(dt.getDate()).padStart(2,'0');
    return `${m}/${day}/${dt.getFullYear()}`;
  };
  const body = { list_name: 'ALL', start_date: toMMDDYYYY(startRaw), end_date: toMMDDYYYY(endRaw) };
  showMessage("Computing productivity...", false);
  try{
    const res = await fetch(API_BASE + "/productivity", { method: "POST", headers: {'content-type':'application/json'}, body: JSON.stringify(body) });
    if(!res.ok){ showMessage("Error computing productivity"); return; }
    const data = await res.json();
    renderProductivity(data.data);
  }catch(err){
    showMessage("Error: " + err);
  }
});

function renderList(payload){
  const container = document.getElementById('tableContainer');
  container.innerHTML = '';
  const s = document.createElement('div');
  s.innerHTML = `<strong>Total Minutes:</strong> ${payload.total_minutes} &nbsp; <strong>Process Types:</strong> ${JSON.stringify(payload.process_types)}`;
  container.appendChild(s);

  const table = document.createElement('table');
  table.innerHTML = `<thead><tr><th>Title</th><th>Date</th><th>Minutes</th><th>Process</th></tr></thead><tbody></tbody>`;
  const tbody = table.querySelector('tbody');
  for(const row of payload.detailed_data){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${row.Title}</td><td>${row.Date}</td><td>${row.Minutes}</td><td>${row.Process || ''}</td>`;
    tbody.appendChild(tr);
  }
  container.appendChild(table);
}

function renderProductivity(rows){
  const container = document.getElementById('summary');
  container.innerHTML = '<h3>Productivity</h3>';
  const table = document.createElement('table');
  table.innerHTML = `<thead><tr><th>User</th><th>Minutes</th></tr></thead><tbody></tbody>`;
  const tbody = table.querySelector('tbody');
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.user}</td><td>${r.minutes}</td>`;
    tbody.appendChild(tr);
  });
  container.appendChild(table);
  showMessage('Productivity loaded', false);
}
</script>
</body>
</html>
