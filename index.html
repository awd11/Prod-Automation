<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Inter", sans-serif; }
        .chart-container { position: relative; height: 40vh; width: 100%; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Production Dashboard</h2>
            <p class="text-gray-600 mb-4">Please run the local `app.py` script on your computer before logging in.</p>
            <div>
                <label for="username" class="sr-only">Username</label>
                <input type="text" id="username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Enter your username to view your data">
            </div>
            <button id="login-btn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                View Dashboard
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
        </div>
    </div>

    <!-- DASHBOARD (HIDDEN) -->
    <div id="dashboard" class="hidden">
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">Productivity Dashboard</h1>
                <div>
                    <span id="welcome-user" class="text-gray-600 mr-4"></span>
                    <button id="logout-btn" class="text-sm text-indigo-600 hover:text-indigo-800">Logout</button>
                </div>
            </div>
        </header>
        <main class="container mx-auto p-4 md:p-6">
            <div id="loading-view" class="text-center p-10">
                <div class="loader inline-block"></div>
                <p class="mt-4 text-gray-600">Fetching live data from your local bridge...</p>
            </div>
            <div id="dashboard-content" class="hidden">
                <div id="manager-controls" class="hidden mb-6 bg-white p-4 rounded-lg shadow">
                     <label for="user-select" class="block text-sm font-medium text-gray-700">Select Team Member to View:</label>
                     <select id="user-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Daily Productivity (Last 7 Days)</h3>
                        <div class="chart-container"><canvas id="daily-chart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Total Tickets by User (Last 7 Days)</h3>
                        <div class="chart-container"><canvas id="pie-chart"></canvas></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
    // In this model, roles are for VIEWING permissions only.
    // The keys should be the simple username (e.g., 'jdoe'), not the full SharePoint name.
    const ROLES = { 
        'manager_user': 'manager', 
        'admin_user': 'manager' 
        // Add other managers or admins here
    };
    
    // Chart instances
    let allData = [], dailyChart = null, pieChart = null;

    document.addEventListener('DOMContentLoaded', () => {
        const loggedInUser = sessionStorage.getItem('loggedInUser');
        if (loggedInUser) {
            initDashboard(JSON.parse(loggedInUser));
        }
        document.getElementById('login-btn').addEventListener('click', handleLogin);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        document.getElementById('user-select')?.addEventListener('change', () => {
            const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            updateCharts(currentUser.username, currentUser.role);
        });
    });

    function handleLogin() {
        const username = document.getElementById('username').value.toLowerCase().trim();
        if (!username) {
            document.getElementById('login-error').textContent = "Please enter your username.";
            return;
        }
        const role = ROLES[username] || 'user';
        const userData = { username, role };
        sessionStorage.setItem('loggedInUser', JSON.stringify(userData));
        initDashboard(userData);
    }
    
    function handleLogout() {
        sessionStorage.removeItem('loggedInUser');
        location.reload();
    }
    
    async function initDashboard(user) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('welcome-user').textContent = `Welcome, ${user.username}!`;

        try {
            // This is the key change: it calls the user's local server
            const response = await fetch('http://localhost:5000/data');
            if (!response.ok) {
                 const errorData = await response.json();
                 throw new Error(errorData.error || `Local bridge returned status: ${response.status}`);
            }
            allData = await response.json();
            allData.forEach(d => d.date = new Date(d.date));
            
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById('dashboard-content').classList.remove('hidden');
            
            if (user.role === 'manager') setupManagerView();
            updateCharts(user.username, user.role);

        } catch (error) {
            console.error(error);
            document.getElementById('loading-view').innerHTML = `<p class="text-red-600 font-semibold">Error: Could not connect to the local data bridge.</p><p class="text-gray-500 mt-2">Please ensure the 'app.py' script is running on your computer and try logging in again.</p><p class="text-xs text-gray-400 mt-4">Details: ${error.message}</p>`;
        }
    }
    
    function setupManagerView() {
        const managerControls = document.getElementById('manager-controls');
        const userSelect = document.getElementById('user-select');
        managerControls.classList.remove('hidden');
        const usersInData = [...new Set(allData.map(d => d.user))].sort();
        userSelect.innerHTML = '<option value="all">All Team</option>';
        usersInData.forEach(u => {
            const option = document.createElement('option');
            option.value = u;
            option.textContent = u;
            userSelect.appendChild(option);
        });
    }

    function updateCharts(username, role) {
        let filteredData = [];
        const selectedUser = document.getElementById('user-select')?.value || username;

        // Note: For user roles, we match against the SharePoint user string from the data, which might be "doe, john"
        const usernameToFilter = role === 'user' ? username.replace(/, /g, "").replace(/\s/g, "") : selectedUser;

        if (role === 'manager') {
            filteredData = (selectedUser === 'all') ? allData : allData.filter(d => d.user === selectedUser);
        } else {
             // Find the user's data even if the format is "doe, john"
            filteredData = allData.filter(d => d.user.replace(/, /g, "").replace(/\s/g, "") === usernameToFilter);
        }
        
        const uniqueDays = [...new Set(filteredData.map(d => d.date.toISOString().split('T')[0]))].sort().slice(-7);
        const last7DaysData = filteredData.filter(d => uniqueDays.includes(d.date.toISOString().split('T')[0]));
        
        renderDailyChart(last7DaysData, uniqueDays);
        renderPieChart(last7DaysData);
    }
    
    function renderDailyChart(data, labels) {
        const ctx = document.getElementById('daily-chart').getContext('2d');
        const chartData = {
            labels: labels.map(l => new Date(l).toLocaleDateString()),
            datasets: [{
                label: 'Tickets Processed',
                data: labels.map(day => data.filter(d => d.date.toISOString().startsWith(day)).reduce((sum, item) => sum + item.Productive, 0)),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        };
        if (dailyChart) dailyChart.destroy();
        dailyChart = new Chart(ctx, { type: 'bar', data: chartData, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
    }
    
    function renderPieChart(data) {
        const ctx = document.getElementById('pie-chart').getContext('2d');
        const userTotals = data.reduce((acc, item) => {
            acc[item.user] = (acc[item.user] || 0) + item.Productive;
            return acc;
        }, {});
        
        const chartData = {
            labels: Object.keys(userTotals),
            datasets: [{
                data: Object.values(userTotals),
                backgroundColor: ['#4A90E2', '#50E3C2', '#F5A623', '#F8E71C', '#D0021B', '#9013FE', '#B8E986', '#417505', '#BD10E0'],
                hoverOffset: 4
            }]
        };

        if (pieChart) pieChart.destroy();
        pieChart = new Chart(ctx, { type: 'pie', data: chartData, options: { responsive: true, maintainAspectRatio: false } });
    }

    </script>
</body>
</html>

